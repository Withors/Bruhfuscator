package me.iris.ambien.obfuscator.transformers.implementations.exploits;

import me.iris.ambien.obfuscator.transformers.data.Category;
import me.iris.ambien.obfuscator.transformers.data.Ordinal;
import me.iris.ambien.obfuscator.transformers.data.Stability;
import me.iris.ambien.obfuscator.transformers.data.Transformer;
import me.iris.ambien.obfuscator.transformers.data.annotation.TransformerInfo;
import me.iris.ambien.obfuscator.wrappers.JarWrapper;
import org.objectweb.asm.tree.MethodNode;

@TransformerInfo(
        name = "modify-access",
        category = Category.EXPLOITS,
        stability = Stability.EXPERIMENTAL,
        description = "Adds ACC_BRIDGE & ACC_SYNTHETIC to methods, this causes some decompilers to not decompile the method."
)
public class ModifyAccess extends Transformer {
    @Override
    public void transform(JarWrapper wrapper) {
        getClasses(wrapper).forEach(classWrapper -> {
            // ignore interfaces
            if (classWrapper.isInterface()) return;

            classWrapper.getTransformableMethods().forEach(methodWrapper -> {
                final MethodNode methodNode = methodWrapper.getNode();

                // ignore class initializer
                if (methodNode.name.equals("<init>")) return;

                // modify access
                methodNode.access |= ACC_BRIDGE;
                methodNode.access |= ACC_SYNTHETIC;
            });
        });
    }
}
